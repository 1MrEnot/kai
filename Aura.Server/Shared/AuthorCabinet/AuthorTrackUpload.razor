@using TagLib;
@inject ApplicationDbContext _dbContext;
@inject UserService _userService;
@inject ILogger<AuthorTrackUpload> _logger;

<EditForm Model="_trackModel" OnValidSubmit="CreateTrack">
    <DataAnnotationsValidator/>
    <ValidationSummary/>

    <p>
        <label>
            Обложка
            <InputFile OnChange="UploadCover"></InputFile>
        </label>
    </p>

    <p>
        <label>
            Трек
            <InputFile OnChange="UploadTrack"></InputFile>
        </label>
    </p>

    <p>
        <label>
            Название трека
            <InputText id="filename" @bind-Value="_trackModel.Name" />
        </label>
    </p>

    <button class="btn-outline-primary" type="submit">Загрузить трек</button>

</EditForm>



@code {

    [Parameter]
    public Action OnTrackCreated { get; set; } = () => {};
    private AuthorProfileModel _author;
    private CreateTrackModel _trackModel = new();

    protected override void OnInitialized()
    {
        _author = _userService.GetAsAuthor();
    }

    private void UploadCover(InputFileChangeEventArgs args)
    {
        _trackModel.Cover = args.File;
        _logger.LogInformation("Обложка загружена");
    }

    private void UploadTrack(InputFileChangeEventArgs args)
    {
        _trackModel.Track = args.File;
        _logger.LogInformation("Трек загружен");
    }

    private async Task CreateTrack()
    {
        var author = await _dbContext.Authors.FindAsync(_author.Id);
        var fileArray = await FileToByteArray(_trackModel.Track);
        var coverArray = await FileToByteArray(_trackModel.Cover);

        var trackLength = 143;

        var track = new Track
        {
            Id = Guid.NewGuid(),
            File = fileArray,
            Cover = coverArray,
            Name = _trackModel.Name,
            ReleaseDate = DateTime.Today,
            Duration = trackLength,
            Author = author
        };

        _dbContext.Tracks.Add(track);
        await _dbContext.SaveChangesAsync();

        OnTrackCreated();
        _logger.LogInformation("Трек создан");
    }

    private async Task<byte[]> FileToByteArray(IBrowserFile file)
    {
        await using var memoryStream = new MemoryStream();
        var fileSteam = file.OpenReadStream(8*1024*1024*100);
        await fileSteam.CopyToAsync(memoryStream);
        return memoryStream.ToArray();
    }

    private class CreateTrackModel
    {
        [Required]
        public string Name { get; set; }

        [Required]
        public IBrowserFile Cover { get; set; }

        [Required]
        public IBrowserFile Track { get; set; }
    }
}